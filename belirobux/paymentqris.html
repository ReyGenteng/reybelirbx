<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RobuxNow.xyz - Pembayaran QRIS</title>
    <meta name="keywords" content="beli robux, robux murah, jual robux, robux terpercaya, roblox, top up robux, robux aman, robux instant, robux preorder, robuxnow, robux now, robux ku, robux sekarang">
    <meta name="description" content="Halaman pembayaran RobuxNow.xyz untuk QRIS. Dapatkan Robux dengan cepat dan aman dengan metode pembayaran QRIS.">
    <link rel="icon" type="image/x-icon" href="https://reygenteng.github.io/reybelirbx/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap');
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f8f8;
            color: #333;
        }

        .header {
            padding: 2rem 1rem;
            background-color: #f8f8f8;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .header-logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0;
        }

        .header-logo-container img {
            max-width: 80px;
            height: auto;
        }

        .header h1 {
            color: #222;
            font-size: 1.8em;
            margin: 0;
            font-weight: 700;
            text-align: center;
        }

        .container {
            max-width: 500px;
            margin: 2rem auto;
            padding: 1.5rem;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .qr-container {
            position: relative;
            background-color: #f0f0f0;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            display: inline-block;
        }

        #qr-code {
            width: 100%;
            height: auto;
            max-width: 250px;
            border-radius: 8px;
        }

        .payment-status {
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            color: #fff;
            margin-top: 1rem;
            display: inline-block;
        }
        .status-waiting { background-color: #f9a825; }
        .status-success { background-color: #4CAF50; }
        .status-expired { background-color: #f44336; }
        .status-cancelled { background-color: #777; }
        .status-failed { background-color: #f44336; }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        .info-item:last-child {
            border-bottom: none;
        }

        .btn {
            background-color: #444;
            color: white;
            padding: 12px 20px;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            width: 100%;
            margin-top: 1.5rem;
        }
        .btn:hover {
            background-color: #222;
        }
        .btn-loading .spinner {
            border: 2px solid #fff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            width: 1em;
            height: 1em;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        .btn-loading .btn-text {
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .overlay {
            position: fixed;top:0;left:0;right:0;bottom:0;
            background:rgba(0,0,0,0.7);
            display:none;align-items:center;justify-content:center;
            z-index:999;
        }
        .popup {
            background:#ffffff;color:#333;padding:25px;border-radius:10px;
            width:90%;max-width:400px;text-align:center;transform:scale(0.7);
            transition:transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }
        .popup.show { transform:scale(1); opacity: 1; }
        .popup h2 { color:#222;margin-bottom:10px; }
        .popup button {
            margin-top:10px;border:none;cursor:pointer;padding:12px 20px;border-radius:9999px;
            width: 100%;
            background-color: #444; color: white;
            transition: background-color 0.3s;
        }
        .popup button:hover {
            background-color: #222;
        }
        .popup .info-message {
            margin-bottom: 20px;
            font-size: 1rem;
            line-height: 1.4;
            color: #666;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 style="font-weight: bold; font-size: 1.5rem; margin-bottom: 0.5rem;">Pembayaran</h1>
    <p style="color: #666;">Segera selesaikan pembayaran sebelum waktu habis.</p>

    <div class="qr-container">
        <img id="qr-code" src="" alt="QR Code">
    </div>

    <div class="mt-4">
        <div class="flex items-center justify-center space-x-2 mb-2">
            <span id="status-pembayaran" class="payment-status status-waiting">Menunggu Pembayaran</span>
        </div>
        <p id="hitung-mundur" style="font-weight: bold; font-size: 1.2rem; color: #f44336;"></p>
    </div>

    <div class="mt-6 text-left space-y-2">
        <div class="info-item">
            <span>ID Transaksi</span>
            <span style="font-weight: bold;" id="id-transaksi"></span>
        </div>
        <div class="info-item">
            <span>Username Roblox</span>
            <span style="font-weight: bold;" id="username-roblox"></span>
        </div>
        <div class="info-item">
            <span>Jumlah Robux</span>
            <span style="font-weight: bold;" id="jumlah-robux"></span>
        </div>
        <div class="info-item">
            <span>Total Pembayaran</span>
            <span style="font-weight: bold; font-size: 1.1rem; color: #444;" id="total-pembayaran"></span>
        </div>
    </div>
    
    <button id="tombol-batal" class="btn">
        <span class="btn-text">Batalkan Transaksi</span>
        <span class="spinner" style="display: none;"></span>
    </button>
</div>

<!-- Popup Modal -->
<div class="overlay" id="popupOverlay">
    <div class="popup" id="popupBox">
        <i id="popupIcon" class="fas fa-check-circle" style="font-size:50px;color:#4CAF50;margin-bottom:10px;"></i>
        <h2 id="popupTitle">Sukses</h2>
        <p class="info-message" id="popupMessage">Pesan</p>
        <button onclick="closePopup()">OK</button>
    </div>
</div>

<script>
    // Konfigurasi API dan Waktu
    const KUNCI_API = 'CiaaTopUp_l9aohdltv5xo11bg';
    const URL_API_STATUS = '/api/deposit/status';
    const URL_API_BATAL = '/api/deposit/cancel';
    const WAKTU_KADALUARSA = 15 * 60; // 15 menit dalam detik

    // Elemen DOM
    const qrCodeEl = document.getElementById('qr-code');
    const idTransaksiEl = document.getElementById('id-transaksi');
    const usernameRobloxEl = document.getElementById('username-roblox');
    const jumlahRobuxEl = document.getElementById('jumlah-robux');
    const totalPembayaranEl = document.getElementById('total-pembayaran');
    const hitungMundurEl = document.getElementById('hitung-mundur');
    const statusPembayaranEl = document.getElementById('status-pembayaran');
    const tombolBatalEl = document.getElementById('tombol-batal');

    let waktuTersisa = WAKTU_KADALUARSA;
    let intervalHitungMundur;
    let intervalPolling;
    let idTransaksiSaatIni;

    // Fungsi untuk menampilkan popup
    function tampilkanPesan(pesan, sukses = true) {
        document.getElementById('popupTitle').textContent = sukses ? 'Sukses' : 'Error';
        document.getElementById('popupMessage').textContent = pesan;
        const icon = document.getElementById('popupIcon');
        icon.className = sukses ? 'fas fa-check-circle' : 'fas fa-times-circle';
        icon.style.color = sukses ? '#4CAF50' : '#f44336';
        
        const overlay = document.getElementById('popupOverlay');
        const box = document.getElementById('popupBox');
        overlay.style.display = 'flex';
        setTimeout(() => box.classList.add('show'), 10);
    }

    // Fungsi untuk menutup popup
    function closePopup() {
        const overlay = document.getElementById('popupOverlay');
        const box = document.getElementById('popupBox');
        box.classList.remove('show');
        setTimeout(() => overlay.style.display = 'none', 200);
    }
    
    // Fungsi untuk mengaktifkan/menonaktifkan loading pada tombol
    function aturLoading(tombol, teksEl, spinnerEl, sedangMemuat) {
        tombol.disabled = sedangMemuat;
        if (sedangMemuat) {
            tombol.classList.add('btn-loading');
            teksEl.style.display = 'none';
            spinnerEl.style.display = 'inline-block';
        } else {
            tombol.classList.remove('btn-loading');
            teksEl.style.display = 'inline-block';
            spinnerEl.style.display = 'none';
        }
    }

    // Mengambil data transaksi dari localStorage
    const transaksi = JSON.parse(localStorage.getItem('currentTransaction'));

    if (!transaksi) {
        tampilkanPesan("Tidak ada data transaksi ditemukan. Kembali ke halaman utama.", false);
        setTimeout(() => window.location.href = 'index.html', 3000);
    } else {
        idTransaksiSaatIni = transaksi.refId;
        qrCodeEl.src = transaksi.qr_url;
        idTransaksiEl.textContent = transaksi.refId;
        usernameRobloxEl.textContent = transaksi.username;
        jumlahRobuxEl.textContent = transaksi.robux.toLocaleString('id-ID');
        totalPembayaranEl.textContent = "Rp " + transaksi.amount.toLocaleString('id-ID');

        // Hitung waktu kadaluarsa dari waktu pembuatan
        const waktuDibuat = new Date(transaksi.createdAt).getTime();
        const waktuSekarang = new Date().getTime();
        waktuTersisa = WAKTU_KADALUARSA - Math.floor((waktuSekarang - waktuDibuat) / 1000);

        if (waktuTersisa <= 0) {
            tampilkanPesan("Transaksi sudah kadaluarsa. Silakan buat pesanan baru.", false);
            statusPembayaranEl.textContent = "Kadaluarsa";
            statusPembayaranEl.className = "payment-status status-expired";
            tombolBatalEl.disabled = true;
            hitungMundurEl.textContent = "Transaksi kadaluarsa!";
        } else {
            // Mulai hitung mundur
            intervalHitungMundur = setInterval(() => {
                if (waktuTersisa <= 0) {
                    clearInterval(intervalHitungMundur);
                    clearInterval(intervalPolling);
                    statusPembayaranEl.textContent = "Kadaluarsa";
                    statusPembayaranEl.className = "payment-status status-expired";
                    hitungMundurEl.textContent = "Transaksi kadaluarsa!";
                    tombolBatalEl.disabled = true;
                    tampilkanPesan("Waktu pembayaran telah habis.", false);
                } else {
                    const menit = Math.floor(waktuTersisa / 60);
                    const detik = waktuTersisa % 60;
                    hitungMundurEl.textContent = `${menit}:${detik.toString().padStart(2, '0')}`;
                    waktuTersisa--;
                }
            }, 1000);

            // Mulai polling status pembayaran
            intervalPolling = setInterval(async () => {
                try {
                    const response = await fetch(`${URL_API_STATUS}?id=${idTransaksiSaatIni}`, {
                        method: 'GET',
                        headers: { 'X-APIKEY': KUNCI_API }
                    });
                    const data = await response.json();

                    if (data.success && data.data && data.data.status === 'PAID') {
                        clearInterval(intervalPolling);
                        clearInterval(intervalHitungMundur);
                        statusPembayaranEl.textContent = "Berhasil";
                        statusPembayaranEl.className = "payment-status status-success";
                        hitungMundurEl.textContent = "Pembayaran berhasil!";
                        tombolBatalEl.disabled = true;
                        tampilkanPesan("Pembayaran berhasil. Robux akan segera diproses!", true);
                        localStorage.removeItem('currentTransaction');
                    }
                } catch (error) {
                    console.error("Gagal memeriksa status:", error);
                }
            }, 5000); // Poll setiap 5 detik
        }
    }
    
    // Logika tombol Batalkan Transaksi
    tombolBatalEl.addEventListener('click', async () => {
        const teksBatal = tombolBatalEl.querySelector('.btn-text');
        const loadingBatal = tombolBatalEl.querySelector('.spinner');

        aturLoading(tombolBatalEl, teksBatal, loadingBatal, true);

        try {
            const response = await fetch(`${URL_API_BATAL}?id=${idTransaksiSaatIni}`, {
                method: 'GET',
                headers: {
                    'X-APIKEY': KUNCI_API,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Gagal membatalkan transaksi');
            }

            if (data.success) {
                statusPembayaranEl.textContent = "Dibatalkan";
                statusPembayaranEl.className = "payment-status status-cancelled";
                clearInterval(intervalPolling);
                clearInterval(intervalHitungMundur);
                hitungMundurEl.textContent = "Transaksi dibatalkan!";
                tombolBatalEl.disabled = true;
                tampilkanPesan('Transaksi berhasil dibatalkan. Dana tidak terpotong.');
                localStorage.removeItem('currentTransaction');
            } else {
                throw new Error(data.message || 'Gagal membatalkan transaksi');
            }
        } catch (error) {
            console.error('Error:', error);
            tampilkanPesan(`Error: ${error.message}`, false);
        } finally {
            aturLoading(tombolBatalEl, teksBatal, loadingBatal, false);
        }
    });
</script>
</body>
</html>
